<!doctype html>
<html>
    <head>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.26.0/babel.min.js" integrity="sha512-kp7YHLxuJDJcOzStgd6vtpxr4ZU9kjn77e6dBsivSz+pUuAuMlE2UTdKB7jjsWT84qbS8kdCWHPETnP/ctrFsA==" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/react/16.13.1/umd/react.production.min.js" integrity="sha512-SUJujhtUWZUlwsABaZNnTFRlvCu7XGBZBL1VF33qRvvgNk3pBS9E353kcag4JAv05/nsB9sanSXFbdHAUW9+lg==" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/16.13.1/umd/react-dom.production.min.js" integrity="sha512-SYsXmAblZhruCNUVmTp5/v2a1Fnoia06iJh3+L9B9wUaqpRVjcNBQsqAglQG9b5+IaVCfLDH5+vW923JL5epZA==" crossorigin="anonymous"></script>
        <title>Among Us Solver</title>
        <style>
            li.colour_box{
                display:inline-block;
                width: 15vw;
                text-align: center;
                border:2px solid black;
                border-radius: 0.5em;
            }

            img.tc{
                display:block;
                max-width: 3em;
                max-height: 3em;
                width:10vw;
                height:10vw;
                margin:auto;
            }

            li.num_box{
                display:inline-block;
                width: 1.2em;
                height: 1.2em;
                border:2px solid black;
                border-radius: 4px;
                font-size:30pt;
                text-align:center;
            }

            li.disabled_num{
                border-color:grey;
                color:grey;
            }

            li.selected_num{
                color:red;
                border-color:red;
            }

            div.noticebox{
                border-radius: 5px;
                padding: 1em;
                border: 1px solid #3891ff;
                background-color: #d7f2ff;
            }

            div.noticebox:empty{
                display:none;
            }

            div.error{
                border-color: #ff7d7d;
                background-color: #ffcece;
            }
        </style>
    </head>
    <body>
        <h1>Among Us Solver</h1>
        <div id='content'></div>
        <script type='text/babel'>
            class ColourBox extends React.Component {
                constructor(props){
                    super(props);
                    this.props = props;
                }

                is_ticked(){
                    return this.props.checked;
                }

                imagename(){
                    if (this.is_ticked()) { return 'static/tick.svg'; }
                    return 'static/cross.svg';
                }

                render(){
                    return(
                        <li class='colour_box' style={ {backgroundColor: this.props.colourval} } onClick={this.props.onClick} >
                            { this.props.colourname }
                            <img class='tc' src={this.imagename()}/>
                        </li>
                    );
                }
            }

            class NumberBox extends React.Component {
                constructor(props){
                    super(props);
                    this.props = props;
                }

                render(){
                    return(
                        <li class={'num_box'+(this.props.enabled? ' disabled_num':' ')+(this.props.selected? ' selected_num':' ')} onClick={this.props.onClick} >
                            { this.props.num }
                        </li>
                    );
                }

            }

            class ChooseColours extends React.Component {
                constructor(props){
                    super(props);
                    this.props = props;
                    this.state = {checked: [true, true, true, true, true, false, false, false, false, false, false, false]};
                    this.toggle = this.toggle.bind(this);
                }

                player_count(){
                    return this.state.checked.map(c=>(c?1:0)).reduce((a,b)=>a+b,0);
                }

                toggle(i){
                    this.setState((state, props) => {
                        let c = state.checked;
                        c[i] = !c[i];
                        return {checked: c}
                    });
                }

                render(){
                    return(
                        <div>
                            <ul>
                                {% for c, h in colours.items() %}
                                    <ColourBox colourname='{{ c }}' colourval='#{{ h }}' index='{{ loop.index }}' onClick={()=>{this.toggle({{loop.index0}})}} checked={this.state.checked[{{loop.index0}}]}/>
                                {% endfor %}
                            </ul>
                            <ul>
                                {% for i in range(10) %}
                                    <NumberBox num='{{i+1}}' enabled='false' selected={this.player_count() == {{i+1}} } />
                                {% endfor %}
                            </ul>
                            <span style={ {color:'red', fontWeight: 'bold'} }>{this.player_count()>10?'Too many players':''}</span>
                        </div>
                    );
                }
            }

            class ChooseNumber extends React.Component {
                constructor(props){
                    super(props);
                    this.props = props;
                    this.state = {n:1};
                }

                setnum(n){ this.setState({n}); }

                render(){
                    return(
                        <ul>
                            {Array.from(Array(this.props.max).keys()).map(i =>
                                <NumberBox num={i+1} onClick={()=>{this.setnum(i+1);}} selected={this.state.n == i+1}/>
                            )}
                        </ul>
                    );
                }
            }

            class NoticeBox extends React.Component {
                constructor(props){
                    super(props);
                    this.props = props;
                }

                render(){
                    return(
                        <div class={'noticebox' + (this.props.error?' error':'')}>
                            { this.props.msg }
                        </div>
                    );
                }
            }

            let colnames = [
                {% for c in colours.keys() %}
                    "{{c}}",
                {% endfor %}
            ];

            let colmap = {
                {% for c, h in colours.items() %}
                    {{c}}: '#{{h}}',
                {% endfor %}
            }

            function do_post(path, j){
                return fetch(path, {
                    method: 'POST'
                    ,headers: {'Content-Type': 'application/json'}
                    ,body: JSON.stringify(j)
                })
                .then(r=>r.json())
            }

            class GameStarter extends React.Component {
                constructor(props){
                    super(props);
                    this.props = props;
                    this.col_picker = React.createRef();
                    this.num_picker = React.createRef();
                    this.state = {msg:'', iserror:false}
                    this.startgame = this.startgame.bind(this);
                    this.handle_response = this.handle_response.bind(this);
                }

                handle_response(r){
                    this.setState({msg: r.msg, iserror:r.result == 'error'});
                    if (r.result == 'success'){
                        if ('token' in r){
                            run_game(r.token, r.colours);
                        }
                    }
                }

                startgame(){
                    let colours = [];
                    let flags = this.col_picker.current.state.checked;
                    for (var i = 0; i<= flags.length-1; i++){
                        if (flags[i]){
                            colours.push(colnames[i]);
                        }
                    }
                    let start_state = {
                        impostors: this.num_picker.current.state.n
                        ,colours: colours
                    }
                    do_post('/startgame', start_state).then(this.handle_response);
                }

                render(){
                    return(
                        <div>
                            <NoticeBox ref={this.notice_box} msg={this.state.msg} error={this.state.iserror} />
                            <h2>Players in game</h2>
                            <ChooseColours ref={this.col_picker}/>
                            <h2>Number of impostors</h2>
                            <ChooseNumber ref={this.num_picker} max={3} />
                            <button onClick={this.startgame}>Start game</button>
                        </div>
                    );
                }
            }


            /*

            The various ways you can learn information about the hidden game state:

            def learn_certain_not_impostor(self, colour):
                """ learn that the player with the specified colour is certainly not an impostor """

            def learn_certain_impostor(self, colour):
                """ learn that the player with the specified colour is certainly an impostor """

            def learn_murder(self, colour):
                """ Learn that the specified colour has been murdered """

            def learn_ejected(self, colour):
                """ Learn that the specified colour has been ejected"""

            def learn_set_includes_impostors(self, colours):
                """ learn that the players with the specified colours form a group that contains at least one

            */


            class LearnBox extends React.Component {
                constructor(props){
                    super(props);
                    this.props = props;
                    this.state = {selected: false}
                }

                render(){
                    return(
                        <li class='colour_box' style={ {backgroundColor: this.props.colourval} } onClick={this.props.onClick} >
                            { this.props.colourname }
                            <div><button>Murdered</button></div>
                            <div><button>Ejected</button></div>
                            <div><button>Crewmate</button></div>
                            <div><button>Impostor</button></div>
                            <p>{ this.props.model_count }</p>
                        </li>
                    );
                }
            }

            class GameUI extends React.Component {
                constructor(props){
                    super(props);
                    this.props = props;
                    let model_counts = {}
                    props.colours.forEach(c=>{
                        model_counts[c] = -1;
                    });
                    this.state = {msg:'', iserror:false, model_counts};
                    this.handle_response = this.handle_response.bind(this);
                }

                handle_response(r){
                    this.setState({msg: r.msg, iserror:r.result == 'error'});
                    if (r.result == 'success'){
                        // TODO
                    }
                }

                render(){
                    return(
                        <div>
                            <NoticeBox ref={this.notice_box} msg={this.state.msg} error={this.state.iserror} />
                            <h2>Game in progress</h2>
                            <ul>
                                {this.props.colours.map(c =>
                                    <LearnBox colourname={c} colourval={colmap[c]} model_count={this.state.model_counts[c]} />
                                )}
                            </ul>
                        </div>
                    );
                }
            }

            function run_game(token, colours){
                console.log('Run game with token: ' + token);
                ReactDOM.render(
                    <GameUI token={token} colours={colours} />
                    ,document.getElementById('content')
                );

            }

            function configure_game(){
                ReactDOM.render(
                    <GameStarter />
                    ,document.getElementById('content')
                );
            }

            configure_game();
        </script>
    </body>
</html>
